services:
  bongosec-master:
    profiles:
      - standalone
      - cluster
    build:
      context: .
      dockerfile: base/manager/manager.Dockerfile
    image: integration_test_bongosec-manager
    hostname: bongosec-master
    ports:
      - "55000:55000"
    volumes:
      - ./configurations/tmp/manager:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - bongosec-master
      - master-node
      - master
      - ${ENV_MODE}

  bongosec-worker1:
    profiles:
      - cluster
    image: integration_test_bongosec-manager
    hostname: bongosec-worker1
    volumes:
      - ./configurations/tmp/manager:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - bongosec-master
      - worker1
      - worker
    depends_on:
      - bongosec-master

  bongosec-worker2:
    profiles:
      - cluster
    image: integration_test_bongosec-manager
    hostname: bongosec-worker2
    volumes:
      - ./configurations/tmp/manager:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - bongosec-master
      - worker2
      - worker
    depends_on:
      - bongosec-master

  bongosec-agent1:
    profiles:
      - standalone
      - cluster
    build:
      context: .
      dockerfile: base/agent/new.Dockerfile
    image: integration_test_bongosec-agent
    hostname: bongosec-agent1
    volumes:
      - ./configurations/tmp/agent:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - haproxy-lb
      - bongosec-agent1
    depends_on:
      - haproxy-lb

  bongosec-agent2:
    profiles:
      - standalone
      - cluster
    image: integration_test_bongosec-agent
    hostname: bongosec-agent2
    volumes:
      - ./configurations/tmp/agent:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - haproxy-lb
      - bongosec-agent2
    depends_on:
      - bongosec-agent1
      - haproxy-lb

  bongosec-agent3:
    profiles:
      - standalone
      - cluster
    image: integration_test_bongosec-agent
    hostname: bongosec-agent3
    volumes:
      - ./configurations/tmp/agent:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - haproxy-lb
      - bongosec-agent3
    depends_on:
      - bongosec-agent2
      - haproxy-lb

  bongosec-agent4:
    profiles:
      - standalone
      - cluster
    image: integration_test_bongosec-agent
    hostname: bongosec-agent4
    volumes:
      - ./configurations/tmp/agent:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - haproxy-lb
      - bongosec-agent4
    depends_on:
      - bongosec-agent3
      - haproxy-lb

  bongosec-agent5:
    profiles:
      - standalone
      - cluster
    build:
      context: .
      dockerfile: base/agent/old.Dockerfile
    image: integration_test_bongosec-agent_old
    hostname: bongosec-agent5
    volumes:
      - ./configurations/tmp/agent:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - haproxy-lb
      - bongosec-agent5
      - agent_old
    depends_on:
      - bongosec-agent4
      - haproxy-lb

  bongosec-agent6:
    profiles:
      - standalone
      - cluster
    image: integration_test_bongosec-agent_old
    hostname: bongosec-agent6
    volumes:
      - ./configurations/tmp/agent:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - haproxy-lb
      - bongosec-agent6
      - agent_old
    depends_on:
      - bongosec-agent5
      - haproxy-lb

  bongosec-agent7:
    profiles:
      - standalone
      - cluster
    image: integration_test_bongosec-agent_old
    hostname: bongosec-agent7
    volumes:
      - ./configurations/tmp/agent:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - haproxy-lb
      - bongosec-agent7
      - agent_old
    depends_on:
      - bongosec-agent6
      - haproxy-lb

  bongosec-agent8:
    profiles:
      - standalone
      - cluster
    image: integration_test_bongosec-agent_old
    hostname: bongosec-agent8
    volumes:
      - ./configurations/tmp/agent:/tmp_volume
      - ./tools/:/tools
    entrypoint:
      - /scripts/entrypoint.sh
      - haproxy-lb
      - bongosec-agent8
      - agent_old
    depends_on:
      - bongosec-agent7
      - haproxy-lb

  haproxy-lb:
    profiles:
      - standalone
      - cluster
    build:
      context: ./base/haproxy-lb
    image: integration_test_haproxy-lb
    entrypoint:
      - /scripts/entrypoint.sh
      - ${ENV_MODE}
    depends_on:
      - bongosec-master
      - bongosec-worker1
      - bongosec-worker2

  cti:
    profiles:
      - standalone
      - cluster
    build:
      context: ./base/cti
    image: integration_test_cti
    restart: always
    environment:
      - PORT=4041
